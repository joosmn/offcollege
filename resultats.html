<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Résultats – Podium & Classement</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7f8fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --gold:#f59e0b; --silver:#9ca3af; --bronze:#d97706;
      --accent:#8b5cf6; --accent2:#60a5fa;

      /* Couleurs Team vs Team */
      --teamA:#10b981; --teamA2:#34d399;  /* vert */
      --teamB:#3b82f6; --teamB2:#60a5fa;  /* bleu */
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    header{ text-align:center; margin-bottom:18px;}
    h1{margin:0 0 6px; font-size:24px;}
    #meta{color:var(--muted); font-size:13px;}

    .section{margin:18px 0}
    .card{ background:var(--card); border:1px solid #eef; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.07); padding:16px }

    /* Podium classique (individuel) */
    .podium-grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; align-items:end; }
    .step{ position:relative; background:linear-gradient(180deg,#fafafa,#f0f0ff);
      border:1px solid #e6e8ff; border-radius:12px; padding:12px; text-align:center;
      box-shadow: inset 0 2px 8px rgba(0,0,0,.04); min-height:120px; }
    .step .rank{ position:absolute; top:-12px; left:50%; transform:translateX(-50%);
      font-weight:900; font-size:12px; color:#fff; padding:4px 8px; border-radius:999px; }
    .r1 .rank{ background:var(--gold); } .r2 .rank{ background:var(--silver); } .r3 .rank{ background:var(--bronze); }
    .name{ font-weight:900; font-size:18px; }
    .cls { color:var(--muted); font-size:12px; margin-top:2px; }
    .score{ margin-top:8px; font-weight:900; font-size:20px; }

    /* Tableau classement individuel */
    .table{ background:var(--card); border:1px solid #eef; border-radius:16px; overflow:hidden; box-shadow:0 10px 24px rgba(0,0,0,.07); }
    .thead, .row{ display:grid; grid-template-columns: 64px 1fr 160px 120px; gap:10px; align-items:center; }
    .thead{ background:#f4f6ff; color:#374151; font-weight:800; padding:12px 14px; }
    .row{ padding:12px 14px; border-top:1px solid #f0f2ff; }
    .rank-badge{ font-weight:900; background:#eef2ff; color:#1e2a5c; padding:6px 10px; border-radius:999px; width:max-content; }

    /* === Vue spéciale Team vs Team === */
    .tvt-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .team-col{ border-radius:16px; padding:14px; }
    .teamA-col{ background: linear-gradient(180deg,#f7fffb,#ffffff); border:1px solid rgba(16,185,129,.25); box-shadow:0 10px 24px rgba(16,185,129,.12); }
    .teamB-col{ background: linear-gradient(180deg,#f7fbff,#ffffff); border:1px solid rgba(59,130,246,.25); box-shadow:0 10px 24px rgba(59,130,246,.12); }

    .team-title{ display:flex; align-items:baseline; gap:8px; margin:0 0 8px; }
    .team-title .name{ font-size:20px; font-weight:900; }
    .team-title .score{ font-size:16px; }
    .teamA-col .name{ color: var(--teamA); }
    .teamB-col .name{ color: var(--teamB); }

    .mini-table{ width:100%; border-collapse:collapse; }
    .mini-table th, .mini-table td{ padding:8px 8px; text-align:left; border-bottom:1px solid #eff2f7; }
    .mini-table th{ font-size:12px; text-transform:uppercase; letter-spacing:.3px; color:#334155; }
    .mini-table td.final{ font-weight:900; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:900; font-size:12px; }
    .pillA{ background:rgba(16,185,129,.12); color:#065f46; border:1px solid rgba(16,185,129,.25); }
    .pillB{ background:rgba(59,130,246,.12); color:#1e3a8a; border:1px solid rgba(59,130,246,.25); }

    .actions{ margin-top:14px; text-align:right; }
    .btn{ border:0; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:800;
      background: linear-gradient(135deg, var(--accent), var(--accent2)); color:#fff; }
    .btn.secondary{ background:#e5e7eb; color:#111827; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Résultats</h1>
      <div id="meta"></div>
    </header>

    <!-- Section Team vs Team -->
    <section id="tvt" class="section" style="display:none;">
      <div class="card">
        <div class="tvt-grid">
          <div class="team-col teamB-col">
            <h3 class="team-title"><span class="name" id="tNameB">Bleus</span> <span class="score" id="tScoreB"></span></h3>
            <table class="mini-table" id="tableB"></table>
          </div>
          <div class="team-col teamA-col">
            <h3 class="team-title"><span class="name" id="tNameA">Verts</span> <span class="score" id="tScoreA"></span></h3>
            <table class="mini-table" id="tableA"></table>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="finishBtn">✅ Terminer la partie</button>
          <button class="btn secondary" onclick="window.location.href='admin.html'">⬅️ Retour</button>
        </div>
      </div>
    </section>

    <!-- Classement individuel (autres modes : classique & duo) -->
    <section id="std" class="section">
      <div class="card"><div id="podium"></div></div>
      <div class="section"><div class="table" id="table"></div></div>
      <div class="actions"><button class="btn secondary" onclick="window.location.href='admin.html'">⬅️ Retour</button></div>
    </section>
  </div>

  <script>
    // Récupération de la dernière photo envoyée par jeu.html
    const data = JSON.parse(localStorage.getItem('lastGameResults') || '{}');
    const results = Array.isArray(data.results) ? data.results : [];
    const ts = data.timestamp || Date.now();

    // En-tête
    const d = data.timestamp ? new Date(data.timestamp) : null;
    const dateStr = d ? d.toLocaleString() : '';
    document.getElementById('meta').textContent =
      `${data.nomPartie || 'Partie'}${data.subject ? ' — '+data.subject : ''}${dateStr ? ' • '+dateStr : ''}`;

    // ====== MODE TEAM VS TEAM (détection par présence de teamMode + playerAwards) ======
    if (data.teamMode && data.playerAwards) {
      const tm = data.teamMode;
      const teamOf = tm.teamOf || {};
      const rawBy = tm.rawByPlayer || {};
      const awards = data.playerAwards || {};

      // Totaux (sécurisé : si absents on recalcule à partir des résultats et des sides)
      let scoreA = typeof tm.scoreA === 'number' ? tm.scoreA : 0;
      let scoreB = typeof tm.scoreB === 'number' ? tm.scoreB : 0;
      if (!scoreA && !scoreB) {
        results.forEach(r=>{
          if (r.side === 'A') scoreA += (r.score||0);
          else if (r.side === 'B') scoreB += (r.score||0);
          else {
            const first = (r.members && r.members[0]) || '';
            const side = teamOf[first];
            if (side === 'A') scoreA += (r.score||0);
            else if (side === 'B') scoreB += (r.score||0);
          }
        });
      }

      // Répartition des joueurs par camp
      const listA = [], listB = [];
      Object.keys(awards).forEach(name=>{
        const side = teamOf[name]; // 'A' | 'B'
        const rawPts = +(rawBy[name] || 0);
        const finalPts = +(awards[name] || 0);
        const row = { name, rawPts, finalPts };
        (side === 'B' ? listB : listA).push(row);
      });

      // Afficher la vue TVT
      document.getElementById('std').style.display = 'none';
      document.getElementById('tvt').style.display = 'block';
      document.getElementById('tNameA').textContent = tm.teamA || 'Équipe A';
      document.getElementById('tNameB').textContent = tm.teamB || 'Équipe B';
      document.getElementById('tScoreA').textContent = `• ${scoreA} pts (à ${tm.playersA||listA.length} joueurs)`;
      document.getElementById('tScoreB').textContent = `• ${scoreB} pts (à ${tm.playersB||listB.length} joueurs)`;

      function renderTeamTable(elId, rows, pillClass){
        const el = document.getElementById(elId);
        if (!rows.length){ el.innerHTML = `<tr><td>Aucun joueur</td></tr>`; return; }
        rows.sort((a,b)=> b.rawPts - a.rawPts || a.name.localeCompare(b.name,'fr'));
        el.innerHTML = `
          <thead>
            <tr><th>Joueur</th><th>Points marqués</th><th>Attribués</th></tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td><span class="pill ${pillClass}">${r.name}</span></td>
                <td>${Number.isInteger(r.rawPts)? r.rawPts : r.rawPts.toFixed(2)} pts</td>
                <td class="final">${Number.isInteger(r.finalPts)? r.finalPts : r.finalPts.toFixed(2)} pts</td>
              </tr>`).join('')}
          </tbody>`;
      }
      renderTeamTable('tableA', listA, 'pillA'); // Verts
      renderTeamTable('tableB', listB, 'pillB'); // Bleus

      // Bouton "Terminer" : applique les attributions individuelles une seule fois (anti-doublon par timestamp)
      document.getElementById('finishBtn').onclick = ()=>{
        const already = localStorage.getItem('awardsAppliedAt');
        if (already && +already === ts) {
          alert("Points déjà attribués pour cette partie.");
          window.location.href = 'admin.html';
          return;
        }
        const students = JSON.parse(localStorage.getItem('students') || '[]');
        const idx = new Map(students.map((s,i)=>[s.name,{i,s}]));
        let applied = 0;
        Object.entries(awards).forEach(([name, pts])=>{
          const slot = idx.get(name);
          if (!slot) return;
          slot.s.points = (slot.s.points || 0) + Number(pts||0);
          students[slot.i] = slot.s; applied++;
        });
        localStorage.setItem('students', JSON.stringify(students));
        localStorage.setItem('awardsAppliedAt', String(ts));
        alert(`Points attribués à ${applied} élève(s).`);
        window.location.href = 'admin.html';
      };

    } else {
      // ====== MODES CLASSIQUE & DUO : CLASSEMENT INDIVIDUEL ======

      // Transforme la liste d'équipes (results) en liste de joueurs {name, classe, scoreIndiv}
      // - DUO : score équipe / nb membres
      // - SOLO : score tel quel
      const perPlayer = [];

      results.forEach(r => {
        const members = Array.isArray(r.members) ? r.members : (typeof r.teamKey === 'string' ? r.teamKey.split(' + ') : []);
        const classes = typeof r.classes === 'string' ? r.classes.split(' / ') : [];
        const share = (r && typeof r.score === 'number' ? r.score : 0) / Math.max(1, members.length);

        members.forEach((name, idx) => {
          const cleanName = (name || '').toString();
          if (!cleanName) return;
          const cls = classes[idx] || '';
          perPlayer.push({
            name: cleanName,
            classe: cls,
            score: share
          });
        });
      });

      // Aggrégation (au cas où un joueur apparaitrait deux fois dans la même partie)
      const merged = new Map();
      perPlayer.forEach(p => {
        const prev = merged.get(p.name);
        if (!prev) merged.set(p.name, { name: p.name, classe: p.classe, score: p.score });
        else merged.set(p.name, { name: p.name, classe: prev.classe || p.classe, score: prev.score + p.score });
      });

      const players = Array.from(merged.values())
        .sort((a,b)=> b.score - a.score || a.name.localeCompare(b.name,'fr'));

      // --- Rendu Podium (individuel) ---
      const podiumEl = document.getElementById('podium');
      if (!players.length) {
        podiumEl.innerHTML = '<div style="text-align:center; padding:24px;">Aucun résultat trouvé.</div>';
      } else {
        const steps = [players[1], players[0], players[2]]; // 2e - 1er - 3e
        const ranks = ['r2','r1','r3'];
        podiumEl.innerHTML = `
          <div class="podium-grid">
            ${steps.map((p, i) => p ? `
              <div class="step ${ranks[i]}">
                <div class="rank">${i===0?'2ᵉ': i===1?'1ᵉʳ':'3ᵉ'}</div>
                <div class="name">${p.name}</div>
                <div class="cls">${p.classe || ''}</div>
                <div class="score">${Number.isInteger(p.score)? p.score : p.score.toFixed(2)} pts</div>
              </div>`: `<div></div>`).join('')}
          </div>`;
      }

      // --- Rendu Tableau (individuel) ---
      const tableEl = document.getElementById('table');
      tableEl.innerHTML = `
        <div class="thead">
          <div>#</div><div>Joueur</div><div>Classe</div><div>Score</div>
        </div>
        ${players.map((p, idx)=>`
          <div class="row">
            <div><span class="rank-badge">${idx+1}</span></div>
            <div>
              <div class="name">${p.name}</div>
            </div>
            <div class="cls">${p.classe || ''}</div>
            <div class="score">${Number.isInteger(p.score)? p.score : p.score.toFixed(2)} pts</div>
          </div>`).join('')}
      `;

      function appliquerPoints() {
  const students = JSON.parse(localStorage.getItem('students') || '[]');
  const indexMap = new Map(students.map((s,i)=>[s.name,{i,s}]));

  players.forEach(p => {
    const slot = indexMap.get(p.name);
    if (slot) {
      slot.s.points = (slot.s.points || 0) + p.score;
      students[slot.i] = slot.s;
    }
  });

  localStorage.setItem('students', JSON.stringify(students));
  alert("Points ajoutés au classement !");
}

const btn = document.createElement('button');
btn.textContent = "✅ Terminer la partie";
btn.className = "btn";
btn.onclick = appliquerPoints;
document.querySelector('#std .actions').prepend(btn);

    }

  </script>
</body>
</html>
