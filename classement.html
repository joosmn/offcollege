<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Classement G√©n√©ral</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --bg: #f8faf9;
  --mint: #a7f3d0;
  --mint-strong: #34d399;
  --text: #0f172a;
  --muted: #6b7280;
  --border: #e5e7eb;
  --gold: #fbbf24;
  --silver: #d1d5db;
  --bronze: #f59e0b;
}
*{box-sizing:border-box}
body {
  font-family: system-ui, ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial;
  background: linear-gradient(160deg,#fff,#f8faf9 40%,#e6fff3 100%);
  margin: 0;
  padding: 20px;
  color: var(--text);
}
.container {
  max-width: 1000px;
  margin: auto;
  background: white;
  border-radius: 20px;
  padding: 25px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
}
h1 {
  text-align: center;
  margin-bottom: 15px;
}
.search-box {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
  gap: 8px;
}
.search-box input {
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  font-size: 15px;
  width: 300px;
}
.search-box .icon { font-size: 18px; color: var(--muted); }

.podium {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 30px 0 40px;
  flex-wrap: wrap;
}
.podium .player { text-align: center; }
.podium .avatar {
  width: 90px; height: 90px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; font-weight: 700; color: white;
}
.podium .name { margin-top: 6px; font-weight: 600; }
.podium .score { color: var(--mint-strong); font-weight: 700; }

.list { display: flex; flex-direction: column; gap: 10px; }
.item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 14px; background: #fdfdfd; border: 1px solid var(--border);
  border-radius: 12px;
}
.item:hover { background: #f8fdfb; }
.item .left { display: flex; align-items: center; gap: 10px; }
.avatar-small {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; color: white;
}
.score { font-weight: 700; color: var(--mint-strong); }

.details-btn {
  background: var(--mint);
  border: none; border-radius: 8px;
  padding: 4px 8px; font-size: 12px; cursor: pointer;
  color: #064e3b; transition: background .2s;
}
.details-btn:hover { background: var(--mint-strong); color: #fff; }

.modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.4);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity .3s ease;
}
.modal.active { opacity: 1; pointer-events: auto; }
.modal-content {
  background: white; border-radius: 16px; padding: 20px;
  max-width: 420px; width: 90%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
.modal-header { font-weight: 800; font-size: 18px; margin-bottom: 10px; }
.modal-body { font-size: 14px; line-height: 1.5; }
.close-btn {
  margin-top: 15px;
  background: var(--mint); border: 0; padding: 8px 14px;
  border-radius: 8px; cursor: pointer; font-weight: 700; color: #064e3b;
}
.close-btn:hover { background: var(--mint-strong); color: #fff; }
</style>
</head>
<body>
<div class="container">
  <h1>üèÜ Classement G√©n√©ral</h1>
  <div class="search-box">
    <span class="icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Rechercher un √©l√®ve...">
  </div>
  <div class="podium" id="podium"></div>
  <div class="list" id="rankingList"></div>
</div>

<!-- Modal d√©tails -->
<div class="modal" id="detailsModal" onclick="if(event.target===this)closeModal()">
  <div class="modal-content">
    <div class="modal-header" id="modalTitle"></div>
    <div class="modal-body" id="modalBody"></div>
    <button class="close-btn" onclick="closeModal()">Fermer</button>
  </div>
</div>

<script>
/* ========= Utils ========= */
const initials = name => (name||'').trim().split(/\s+/).map(n=>n[0]||'').join('').slice(0,2).toUpperCase();
const colorAt  = i => ["#f87171","#60a5fa","#34d399","#fbbf24","#a78bfa","#f472b6","#fb923c"][i%7];
const canon    = s => String(s||"").normalize('NFC').trim().replace(/\s+/g,' ').toLowerCase();

/* ========= Agr√©gation robuste (anti-doublons) ========= */
let AGG_INDEX = new Map(); // key -> {display, total, classes(Map), subjects(Object)}

function aggregatePointsIndividuels(){
  const students = JSON.parse(localStorage.getItem("students") || "[]");
  AGG_INDEX = new Map();

  function ensure(key, display){
    if (!AGG_INDEX.has(key)){
      AGG_INDEX.set(key, { display, total:0, classes:new Map(), subjects:{} });
    }else{
      // garde un "display" le plus propre (le plus long)
      const rec = AGG_INDEX.get(key);
      if ((display||'').length > (rec.display||'').length) rec.display = display;
    }
    return AGG_INDEX.get(key);
  }

  for (const s of students){
    if (!s || !s.name) continue;

    // Partage √©quitable si une ligne "DUO" existe encore dans students
    if (s.name.includes("+")){
      const members = s.name.split("+").map(n=>n.trim()).filter(Boolean);
      const share = (s.points||0) / Math.max(1, members.length);
      for (const m of members){
        const k = canon(m);
        const rec = ensure(k, m);
        rec.total += share;
        if (s.classe) rec.classes.set(s.classe, (rec.classes.get(s.classe)||0)+1);
      }
      continue;
    }

    const key = canon(s.name);
    const rec = ensure(key, s.name);
    rec.total += Number(s.points||0);

    if (s.classe) rec.classes.set(s.classe, (rec.classes.get(s.classe)||0)+1);
    if (s.subjects && typeof s.subjects === 'object'){
      for (const [sub, pts] of Object.entries(s.subjects)){
        rec.subjects[sub] = (rec.subjects[sub]||0) + Number(pts||0);
      }
    }
  }

  // Array tri√© pour l‚Äôaffichage
  const arr = [];
  for (const [key, rec] of AGG_INDEX.entries()){
    arr.push([rec.display.trim().replace(/\s+/g,' '), rec.total, key]);
  }
  arr.sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
  return arr;
}

/* ========= Rendu ========= */
function renderRanking(){
  const search = (document.getElementById("searchInput").value||"").toLowerCase().trim();
  const list = document.getElementById("rankingList");
  const podiumDiv = document.getElementById("podium");
  list.innerHTML = ""; podiumDiv.innerHTML = "";

  let ranking = aggregatePointsIndividuels();
  if (search){
    ranking = ranking.filter(([name]) => name.toLowerCase().includes(search));
  }

  // Podium
  const top3 = ranking.slice(0,3);
  const medals = ['var(--gold)','var(--silver)','var(--bronze)'];
  top3.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className = 'player';
    div.innerHTML = `
      <div class="avatar" style="background:${medals[i]}">${initials(p[0])}</div>
      <div class="name">${p[0]}</div>
      <div class="score">${(p[1]||0).toFixed(1)} pts</div>
    `;
    podiumDiv.appendChild(div);
  });

  // Liste compl√®te
  ranking.forEach(([name, score], i)=>{
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div class="left">
        <div class="avatar-small" style="background:${colorAt(i)}">${initials(name)}</div>
        <span>${i+1}. ${name}</span>
      </div>
      <div class="right">
        <span class="score">${(score||0).toFixed(1)} pts</span>
        <button class="details-btn" data-name="${name}">D√©tails</button>
      </div>
    `;
    row.querySelector('.details-btn').onclick = () => showDetails(name);
    list.appendChild(row);
  });
}

/* ========= D√©tails (utilise l‚Äôindex agr√©g√©) ========= */
function showDetails(displayName){
  const key = canon(displayName);
  const rec = AGG_INDEX.get(key);

  document.getElementById("modalTitle").textContent = `Statistiques de ${displayName}`;
  if (!rec){
    document.getElementById("modalBody").innerHTML = "Aucune donn√©e trouv√©e.";
    document.getElementById("detailsModal").classList.add("active");
    return;
  }

  // Classe la plus fr√©quente (sinon 'Inconnue')
  let mainClass = "Inconnue";
  if (rec.classes.size){
    const sorted = [...rec.classes.entries()].sort((a,b)=>b[1]-a[1]);
    mainClass = sorted[0][0];
  }

  let html = `
    <strong>Classe :</strong> ${mainClass}<br>
    <strong>Points totaux (agr√©g√©s) :</strong> ${(rec.total||0).toFixed(1)}<br>
  `;

  const subs = Object.entries(rec.subjects||{}).sort((a,b)=>b[1]-a[1]);
  if (subs.length){
    html += `<br><strong>Par mati√®re :</strong><br>`;
    subs.forEach(([m,pts])=> html += ` - ${m} : ${pts.toFixed(1)} pts<br>`);
  }

  document.getElementById("modalBody").innerHTML = html;
  document.getElementById("detailsModal").classList.add("active");
}
function closeModal(){ document.getElementById("detailsModal").classList.remove("active"); }

document.getElementById("searchInput").addEventListener("input", renderRanking);
renderRanking();
</script>
</body>
</html>
