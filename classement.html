<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Classement G√©n√©ral</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --bg: #f8faf9;
  --mint: #a7f3d0;
  --mint-strong: #34d399;
  --text: #0f172a;
  --muted: #6b7280;
  --border: #e5e7eb;
  --gold: #fbbf24;
  --silver: #d1d5db;
  --bronze: #f59e0b;
  --chip:#f1f5f9;
}
*{box-sizing:border-box}
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(160deg,#fff,#f8faf9 40%,#e6fff3 100%);
  margin: 0;
  padding: 20px;
  color: var(--text);
}
.container {
  max-width: 1100px;
  margin: auto;
  background: white;
  border-radius: 20px;
  padding: 22px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
}
h1 {
  text-align: center;
  margin: 0 0 16px;
}
.toolbar{
  display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:14px
}
@media (min-width:900px){
  .toolbar{ grid-template-columns: auto 1fr auto; align-items:center }
}
.filters{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center
}
select,input[type="search"]{
  padding:10px 12px; border-radius:12px; border:1px solid var(--border);
  font-size:14px; background:#fff; min-width: 160px;
}
.search-box{
  display:flex; align-items:center; gap:8px; justify-self:center
}
.search-box input{ width:280px }
.actions{ justify-self:end; display:flex; gap:8px; flex-wrap:wrap }
.btn{
  background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:800
}
.btn.primary{ background:var(--mint); color:#064e3b; border-color:#9ae6b4 }
.btn.danger{ background:#fff1f2; color:#b91c1c; border-color:#fecdd3 }
.btn:hover{ filter:brightness(0.98) }

.info{
  margin:8px 0 0; color:#475569; font-size:12px; background:#f8fafc; border:1px solid #e2e8f0; padding:8px 10px; border-radius:10px
}

.podium {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
  gap: 16px;
  margin: 18px 0 22px;
}
.podium .player {
  text-align: center;
  background:#fdfdfd; border:1px solid var(--border); border-radius:14px; padding:12px
}
.podium .avatar {
  width: 90px; height: 90px;
  margin: 0 auto 6px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; font-weight: 700; color: white;
  box-shadow: 0 8px 20px rgba(0,0,0,.08)
}
.podium .name { margin-top: 6px; font-weight: 800; }
.podium .meta { font-size:12px; color:var(--muted) }
.podium .score { color: var(--mint-strong); font-weight: 900; margin-top:4px }

.list { display: flex; flex-direction: column; gap: 10px; }
.item {
  display: grid; grid-template-columns: auto 1fr auto; gap:12px; align-items: center;
  padding: 10px 12px;
  background: #fdfdfd; border: 1px solid var(--border);
  border-radius: 12px;
}
.item:hover { background: #f8fdfb; }
.rank{
  width:36px; text-align:center; font-weight:900; color:#0f172a
}
.item .left { display: flex; align-items: center; gap: 10px; min-width:0 }
.avatar-small {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 900; color: white;
}
.name-wrap{ min-width:0 }
.name{ font-weight:900; }
.dim{ color:var(--muted); font-size:12px }
.score { font-weight: 900; color: var(--mint-strong); text-align:right }
.details{
  display:flex; align-items:center; gap:8px
}
.chip{
  background:var(--chip); border:1px solid #e2e8f0; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:800; color:#0f172a
}
.details-btn {
  background: var(--mint);
  border: none; border-radius: 8px;
  padding: 6px 10px; font-size: 12px; cursor: pointer;
  color: #064e3b; font-weight:900
}
.details-btn:hover { background: var(--mint-strong); color: white; }

.empty{
  padding:18px; text-align:center; border:1px dashed var(--border); border-radius:12px; color:var(--muted); font-weight:800;
  background:#fff
}

/* Modal */
.modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.35);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.2s ease; z-index:20
}
.modal.active { opacity: 1; pointer-events: auto; }
.modal-content {
  background: white; border-radius: 16px; padding: 16px;
  max-width: 520px; width: 92%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
.modal-header { font-weight: 900; font-size: 18px; margin-bottom: 8px; }
.modal-body { font-size: 14px; line-height: 1.5; }
.close-btn {
  margin-top: 12px;
  background: var(--mint); border: none; padding: 8px 14px;
  border-radius: 8px; cursor: pointer; font-weight: 900; color: #064e3b;
}
.close-btn:hover { background: var(--mint-strong); color:#fff }
</style>
</head>
<body>
<div class="container">
  <h1>üèÜ Classement G√©n√©ral</h1>

  <div class="toolbar">
    <div class="filters">
      <select id="range">
        <option value="30">30 jours</option>
        <option value="90">90 jours</option>
        <option value="365">365 jours</option>
        <option value="all" selected>Tout</option>
      </select>
      <select id="byClass"><option value="">Toutes classes</option></select>
      <select id="bySubject"><option value="">Toutes mati√®res</option></select>
      <select id="sort">
        <option value="total">Tri : Total points</option>
        <option value="avg">Tri : Moyenne/partie</option>
        <option value="games">Tri : Parties jou√©es</option>
        <option value="last">Tri : Derni√®re activit√©</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;font-size:13px">
        <input type="checkbox" id="mergeNames"> Fusionner homonymes
      </label>
    </div>
    <div class="search-box">
      <input type="search" id="searchInput" placeholder="Rechercher nom‚Ä¶">
    </div>
    <div class="actions">
      <button class="btn" id="filterResetBtn">R√©initialiser filtres</button>
      <button class="btn danger" id="hardResetBtn">‚ôªÔ∏è R√©initialiser le classement</button>
      <button class="btn primary" id="exportBtn">‚¨áÔ∏è Export CSV</button>
    </div>
  </div>

  <div id="ambigInfo" class="info" style="display:none"></div>

  <div class="podium" id="podium"></div>
  <div id="rankingList" class="list"></div>
  <div id="empty" class="empty" style="display:none">Aucune donn√©e pour ces filtres.</div>
</div>

<!-- Modal d√©tails -->
<div class="modal" id="detailsModal" onclick="if(event.target===this)closeModal()">
  <div class="modal-content">
    <div class="modal-header" id="modalTitle"></div>
    <div class="modal-body" id="modalBody"></div>
    <button class="close-btn" onclick="closeModal()">Fermer</button>
  </div>
</div>

<script>
/* ===== Utils ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const esc = s => String(s??"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
const initials = name => (name||'').split(/\s+/).map(x=>x[0]||'').join('').slice(0,2).toUpperCase();
const palette = ["#f87171","#60a5fa","#34d399","#fbbf24","#a78bfa","#f472b6","#fb923c","#22d3ee","#f43f5e","#84cc16"];

function readLS(k, fb){ try{ const raw=localStorage.getItem(k); return raw? JSON.parse(raw): fb; }catch{ return fb; } }
async function writeLS(k, v){
  try{ if (window.DB?.set) await window.DB.set(k, v); }catch{}
  localStorage.setItem(k, JSON.stringify(v));
}

/* Donn√©es de base (classes & noms) */
const STUDENTS = readLS('students', []);
const BY_CLASS = readLS('studentsByClass', {});

/* classes disponibles (depuis √©tudiants + legacy) */
function getAllClasses(){
  const set = new Set(Object.keys(BY_CLASS||{}));
  (STUDENTS||[]).forEach(s=>{ if(s.classe) set.add(s.classe); });
  return [...set].sort();
}
/* mati√®res disponibles (depuis l‚Äôhistorique courant) */
function getAllSubjects(){
  const set = new Set();
  getHistory().forEach(h=>{ if(h.matiere) set.add(h.matiere); });
  return [...set].sort();
}

/* History live (toujours relu) */
function getHistory(){ return readLS('historiqueParties', []); }

/* Index nom -> classes connues (pour filtrage classe + homonymes) */
const NAME_TO_CLASSES = (()=> {
  const map = new Map();
  (STUDENTS||[]).forEach(s=>{
    const n=(s.name||'').trim(); const c=(s.classe||'').trim();
    if(!n) return;
    if(!map.has(n)) map.set(n, new Set());
    if(c) map.get(n).add(c);
  });
  Object.entries(BY_CLASS||{}).forEach(([cls, arr])=>{
    (arr||[]).forEach(n=>{
      n=String(n).trim(); if(!n) return;
      if(!map.has(n)) map.set(n, new Set());
      map.get(n).add(cls);
    });
  });
  const obj={};
  map.forEach((set, n)=> obj[n]=[...set]);
  return obj;
})();

/* Remplit filtres (mati√®re dynamique) */
function fillFilters(){
  const curC = $('#byClass').value;
  const curS = $('#bySubject').value;

  $('#byClass').innerHTML = `<option value="">Toutes classes</option>` + getAllClasses().map(c=>`<option>${esc(c)}</option>`).join('');
  $('#bySubject').innerHTML = `<option value="">Toutes mati√®res</option>` + getAllSubjects().map(m=>`<option>${esc(m)}</option>`).join('');

  if(curC) $('#byClass').value = curC;
  if(curS) $('#bySubject').value = curS;
}
fillFilters();

/* ===== Agr√©gation √† partir de l‚Äôhistorique ===== */
function withinRange(dateIso, rangeVal){
  if(rangeVal==='all') return true;
  const days=parseInt(rangeVal,10)||30;
  const t0=Date.now()-days*24*3600*1000;
  return new Date(dateIso||0).getTime()>=t0;
}

function computeRanking(){
  const HISTORY = getHistory();
  const range = $('#range').value;
  const classFilter = $('#byClass').value.trim();
  const subjectFilter = $('#bySubject').value.trim();
  const merge = $('#mergeNames').checked;
  const q = ($('#searchInput').value||'').toLowerCase();

  const ambig = new Set();
  const acc = new Map();

  (HISTORY||[]).forEach(game=>{
    if(!withinRange(game.dateIso, range)) return;
    if(subjectFilter && (game.matiere||'') !== subjectFilter) return;

    const scores = game.scores || {};
    Object.entries(scores).forEach(([teamKey, score])=>{
      const members = String(teamKey).split('+').map(s=>s.trim()).filter(Boolean);
      const share = Number(score||0) / Math.max(1, members.length);

      members.forEach(n=>{
        const classes = NAME_TO_CLASSES[n] || [];
        let targets = [];

        if(classFilter){
          if(classes.length===0){
            // inconnu -> ignor√© quand filtre de classe actif
            return;
          } else if(classes.includes(classFilter)){
            targets = [{name:n, classe:classFilter}];
          } else {
            return;
          }
        } else {
          if(classes.length<=1){
            const c = classes[0] || '';
            targets = [{name:n, classe:c}];
          } else {
            if(merge){ targets = [{name:n, classe:''}]; }
            else { targets = classes.map(c=>({name:n, classe:c})); }
          }
        }

        if(classFilter && (NAME_TO_CLASSES[n]?.length>1) && !NAME_TO_CLASSES[n].includes(classFilter)){
          ambig.add(n);
        }

        targets.forEach(t=>{
          const key = merge ? t.name.toLowerCase() : (t.name.toLowerCase()+'|'+(t.classe||''));
          if(!acc.has(key)){
            acc.set(key, { name:t.name, classe:t.classe||'', total:0, games:0, lastAt:0, bySubject:{} });
          }
          const row = acc.get(key);
          row.total += share;
          row.games += 1;
          const ts = new Date(game.dateIso||0).getTime() || Date.now();
          row.lastAt = Math.max(row.lastAt, ts);
          const subj = game.matiere || '‚Äî';
          row.bySubject[subj] = (row.bySubject[subj]||0) + share;
          acc.set(key, row);
        });
      });
    });
  });

  // Recherche + tri
  let rows = [...acc.values()];
  if(q) rows = rows.filter(r => r.name.toLowerCase().includes(q));

  const sortBy = $('#sort').value;
  rows.forEach(r => r.avg = r.games? (r.total/r.games):0);
  rows.sort((a,b)=>{
    if(sortBy==='avg')   return (b.avg - a.avg) || (b.total - a.total) || a.name.localeCompare(b.name);
    if(sortBy==='games') return (b.games - a.games) || (b.total - a.total) || a.name.localeCompare(b.name);
    if(sortBy==='last')  return (b.lastAt - a.lastAt) || (b.total - a.total) || a.name.localeCompare(b.name);
    return (b.total - a.total) || (b.avg - a.avg) || a.name.localeCompare(b.name);
  });

  const top3 = rows.slice(0,3);
  return {rows, top3, ambig};
}

/* ===== Rendu ===== */
function render(){
  fillFilters(); // maj "Mati√®res" si l‚Äôhistorique a chang√©
  const {rows, top3, ambig} = computeRanking();
  const podiumDiv = $('#podium');
  const listDiv   = $('#rankingList');
  const empty     = $('#empty');
  const ambigBox  = $('#ambigInfo');

  if(ambig.size && $('#byClass').value){
    ambigBox.style.display='block';
    ambigBox.innerHTML = `‚ÑπÔ∏è <b>Homonymes d√©tect√©s</b> dans la classe filtr√©e : ${[...ambig].slice(0,5).join(', ')}${ambig.size>5?'‚Ä¶':''}. ` +
                         `Si besoin, d√©coche ‚ÄúFusionner homonymes‚Äù et/ou pr√©cise la classe dans <b>√âl√®ves</b>.`;
  }else{
    ambigBox.style.display='none';
  }

  podiumDiv.innerHTML = '';
  const colors = ['var(--gold)', 'var(--silver)', 'var(--bronze)'];
  top3.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className='player';
    div.innerHTML = `
      <div class="avatar" style="background:${colors[i]}">${initials(p.name)}</div>
      <div class="name">${esc(p.name)}</div>
      <div class="meta">${p.classe? esc(p.classe) : '‚Äî'}</div>
      <div class="score">${p.total.toFixed(1)} pts</div>
    `;
    podiumDiv.appendChild(div);
  });

  listDiv.innerHTML = '';
  rows.forEach((r,idx)=>{
    const item = document.createElement('div');
    item.className='item';
    const color = palette[idx % palette.length];
    const dateTxt = r.lastAt ? new Date(r.lastAt).toLocaleDateString() : '‚Äî';
    item.innerHTML = `
      <div class="rank">${idx+1}</div>
      <div class="left">
        <div class="avatar-small" style="background:${color}">${initials(r.name)}</div>
        <div class="name-wrap">
          <div class="name">${esc(r.name)}</div>
          <div class="dim">${r.classe? esc(r.classe) : '‚Äî'} ¬∑ ${r.games} partie(s) ¬∑ moy ${r.avg.toFixed(2)}</div>
        </div>
      </div>
      <div class="details">
        <span class="chip">Derni√®re activit√© : ${esc(dateTxt)}</span>
        <div class="score" style="min-width:110px">${r.total.toFixed(1)} pts</div>
        <button class="details-btn" data-name="${esc(r.name)}" data-classe="${esc(r.classe)}">D√©tails</button>
      </div>
    `;
    listDiv.appendChild(item);
  });

  empty.style.display = rows.length ? 'none' : 'block';

  $$('#rankingList .details-btn').forEach(b=>{
    b.onclick = ()=> showDetails(b.getAttribute('data-name'), b.getAttribute('data-classe'));
  });
}

/* ===== D√©tails ===== */
function showDetails(name, classe){
  const {rows} = computeRanking();
  const row = rows.find(r => r.name===name && (r.classe||'')===(classe||''))
           || rows.find(r => r.name===name);
  $('#modalTitle').textContent = `Statistiques de ${name}${classe? ' ‚Äî '+classe : ''}`;
  let html = '';
  if(row){
    html += `<b>Total</b> : ${row.total.toFixed(1)} pts<br>`;
    html += `<b>Parties jou√©es</b> : ${row.games}<br>`;
    html += `<b>Moyenne/partie</b> : ${row.avg.toFixed(2)}<br>`;
    if(row.lastAt) html += `<b>Derni√®re activit√©</b> : ${new Date(row.lastAt).toLocaleString()}<br>`;
    const subj = Object.entries(row.bySubject||{}).sort((a,b)=>b[1]-a[1]);
    if(subj.length){
      html += `<br><b>Par mati√®re</b> :<br>`;
      subj.forEach(([m,pts])=>{ html += `‚Ä¢ ${esc(m)} : ${pts.toFixed(1)} pts<br>`; });
    }
  } else {
    html = 'Aucune donn√©e.';
  }
  $('#modalBody').innerHTML = html;
  $('#detailsModal').classList.add('active');
}
function closeModal(){ $('#detailsModal').classList.remove('active'); }

/* ===== Export CSV ===== */
function exportCSV(){
  const {rows} = computeRanking();
  const header = ['Rang','Nom','Classe','Total','Parties','Moyenne','Derni√®re activit√©'];
  const lines = [header.join(',')];
  rows.forEach((r,i)=>{
    const cells = [
      i+1, r.name, r.classe||'', r.total.toFixed(2), r.games, r.avg.toFixed(2),
      r.lastAt ? new Date(r.lastAt).toISOString() : ''
    ].map(v => `"${String(v).replace(/"/g,'""')}"`);
    lines.push(cells.join(','));
  });
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `classement_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===== Remise √† z√©ro ===== */
function resetFilters(){
  $('#range').value='all';
  $('#byClass').value='';
  $('#bySubject').value='';
  $('#sort').value='total';
  $('#mergeNames').checked=false;
  $('#searchInput').value='';
  render();
}
async function hardResetClassement(){
  if(!confirm("‚ôªÔ∏è R√©initialiser le classement ?\n\nCela efface tout l‚Äôhistorique des parties (historiqueParties) et remet le classement √† z√©ro.\nLes profils √©l√®ves ne sont pas modifi√©s.\n\nContinuer ?")) return;
  await writeLS('historiqueParties', []);
  alert('Historique des parties effac√©. Le classement est remis √† z√©ro.');
  render();
}

/* ===== √âv√©nements ===== */
$('#searchInput').addEventListener('input', render);
$('#range').addEventListener('change', render);
$('#byClass').addEventListener('change', render);
$('#bySubject').addEventListener('change', render);
$('#sort').addEventListener('change', render);
$('#mergeNames').addEventListener('change', render);
$('#filterResetBtn').addEventListener('click', resetFilters);
$('#hardResetBtn').addEventListener('click', hardResetClassement);
$('#exportBtn').addEventListener('click', exportCSV);

/* ===== Go ===== */
render();
</script>
</body>
</html>
