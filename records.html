<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Hall of Fame ‚Äî Records</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg:#f7fafc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
  --mint:#34d399; --mint2:#a7f3d0;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(160deg,#fff,#f7fafc 40%,#eefcf6);color:var(--text);
     font-family:system-ui,ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;padding:20px}
.container{max-width:1100px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:20px;box-shadow:0 14px 30px rgba(2,6,23,.08);padding:20px}
h1{margin:0 0 12px;text-align:center}
.controls{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;margin:10px 0 18px}
.input,.select{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-weight:700}
.section{margin:16px 0 10px}
.sec-title{display:flex;align-items:center;gap:10px;font-weight:900;margin:0 0 8px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
.row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border:1px dashed var(--line);border-radius:12px}
.left{display:flex;align-items:center;gap:10px}
.badge{font-weight:900;font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#f8fafc}
.k{font-weight:900}
.score{font-weight:900;color:#065f46}
.avatar{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;color:#fff;font-weight:900;background:linear-gradient(135deg,var(--mint),var(--mint2))}
.small{font-size:12px;color:var(--muted)}
.empty{padding:16px;border:1px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted);font-weight:800}
.subtle{color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
    <h1>üéñÔ∏è Hall of Fame ‚Äî Records</h1>
    <div class="controls">
      <select id="subjectFilter" class="select">
        <option value="">Toutes mati√®res</option>
      </select>
      <input id="search" class="input" placeholder="Rechercher (√©quipe / √©l√®ve / partie)">
    </div>

    <div class="section">
      <h3 class="sec-title">ü•á Meilleures √©quipes (une partie)</h3>
      <div class="grid" id="gridTeams"></div>
    </div>

    <div class="section">
      <h3 class="sec-title">üë§ Meilleurs joueurs (une partie)</h3>
      <div class="grid" id="gridPlayers"></div>
    </div>

    <div class="section">
      <h3 class="sec-title">üìö Records par mati√®re</h3>
      <div id="bySubject"></div>
    </div>
  </div>

<script>
const $=s=>document.querySelector(s);
const initials = s => (s||'').trim().split(/\s+/).map(x=>x[0]||'').join('').slice(0,2).toUpperCase();
const norm = s=>String(s||'').toLowerCase();
async function getLS(k, fb){ try{ if(window.DB?.get){ const v=await window.DB.get(k); if(v!==undefined) return v;} }catch{} try{ const raw=localStorage.getItem(k); return raw?JSON.parse(raw):fb; }catch{ return fb; } }

function subjectsSet(hist){ const set=new Set(); (hist||[]).forEach(h=>{ if(h?.matiere) set.add(h.matiere); }); return [...set].sort(); }

function bestTeams(hist, filterSubj, q){
  let rows=[];
  (hist||[]).forEach(h=>{
    if(filterSubj && (h.matiere||'')!==filterSubj) return;
    const game = h.nom || 'Partie';
    const date = h.dateIso ? new Date(h.dateIso) : null;
    const subject = h.matiere || '';
    const scores = h.scores || {};
    Object.entries(scores).forEach(([teamKey,val])=>{
      rows.push({ teamKey, score:Number(val)||0, game, subject, date, dateStr: date?date.toLocaleDateString():'‚Äî' });
    });
  });
  if(q){ const l=norm(q); rows = rows.filter(r=> norm(r.teamKey+' '+r.game).includes(l)); }
  rows.sort((a,b)=> b.score-a.score || (b.date?.getTime()||0)-(a.date?.getTime()||0));
  return rows.slice(0,12);
}
function bestPlayers(hist, filterSubj, q){
  const bestBy=new Map();
  (hist||[]).forEach(h=>{
    if(filterSubj && (h.matiere||'')!==filterSubj) return;
    const game=h.nom||'Partie'; const date=h.dateIso?new Date(h.dateIso):null; const subject=h.matiere||'';
    const scores=h.scores||{};
    Object.entries(scores).forEach(([teamKey,val])=>{
      const pts=Number(val)||0; const members=String(teamKey).split('+').map(s=>s.trim()).filter(Boolean);
      const share = pts/Math.max(1,members.length);
      members.forEach(n=>{
        const key=n.toLowerCase().normalize('NFC').trim();
        const prev=bestBy.get(key);
        if(!prev || share>prev.best){ bestBy.set(key,{name:n,best:share,game,date,dateStr:date?date.toLocaleDateString():'‚Äî',subject}); }
      });
    });
  });
  let rows=[...bestBy.values()];
  if(q){ const l=norm(q); rows = rows.filter(r=> norm(r.name+' '+r.game).includes(l)); }
  rows.sort((a,b)=> b.best-a.best || (b.date?.getTime()||0)-(a.date?.getTime()||0));
  return rows.slice(0,12);
}
function recordsBySubject(hist, q){
  const best=new Map();
  (hist||[]).forEach(h=>{
    const subj=h.matiere||'‚Äî'; const scores=h.scores||{};
    Object.entries(scores).forEach(([teamKey,val])=>{
      const pts=Number(val)||0; const cur=best.get(subj);
      if(!cur || pts>cur.score){ best.set(subj,{subject:subj, teamKey, score:pts, game:h.nom||'Partie', dateStr:h.dateIso?new Date(h.dateIso).toLocaleDateString():'‚Äî'}); }
    });
  });
  let arr=[...best.values()].sort((a,b)=> a.subject.localeCompare(b.subject));
  if(q){ const l=norm(q); arr = arr.filter(r=> norm(r.subject+' '+r.teamKey+' '+r.game).includes(l)); }
  return arr;
}

async function render(){
  const hist = await getLS('historiqueParties', []);
  const subj = $('#subjectFilter').value || '';
  const q = $('#search').value || '';

  // Fill subjects once
  if (!$('#subjectFilter').dataset.filled){
    subjectsSet(hist).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; $('#subjectFilter').appendChild(o); });
    $('#subjectFilter').dataset.filled = '1';
  }

  // Teams
  const teams = bestTeams(hist, subj, q);
  const gt = document.getElementById('gridTeams'); gt.innerHTML = teams.length ? '' : `<div class="empty">Aucune partie enregistr√©e.</div>`;
  teams.forEach(r=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="row">
        <div class="left">
          <div class="avatar" aria-hidden="true">${initials(r.teamKey)}</div>
          <div>
            <div class="k">${r.teamKey}</div>
            <div class="small subtle">${r.game} ‚Ä¢ ${r.dateStr}${r.subject?` ‚Ä¢ ${r.subject}`:''}</div>
          </div>
        </div>
        <div class="score">${r.score} pts</div>
      </div>`;
    gt.appendChild(card);
  });

  // Players
  const players = bestPlayers(hist, subj, q);
  const gp = document.getElementById('gridPlayers'); gp.innerHTML = players.length ? '' : `<div class="empty">Aucun joueur √† afficher.</div>`;
  players.forEach(r=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="row">
        <div class="left">
          <div class="avatar" aria-hidden="true">${initials(r.name)}</div>
          <div>
            <div class="k">${r.name}</div>
            <div class="small subtle">${r.game} ‚Ä¢ ${r.dateStr}${r.subject?` ‚Ä¢ ${r.subject}`:''}</div>
          </div>
        </div>
        <div class="score">${r.best.toFixed(1)} pts</div>
      </div>`;
    gp.appendChild(card);
  });

  // By subject
  const byS = recordsBySubject(hist, q);
  const container = document.getElementById('bySubject'); container.innerHTML='';
  if(!byS.length){ container.innerHTML = `<div class="empty">Aucun record par mati√®re.</div>`; }
  else{
    byS.forEach(rec=>{
      const wrap=document.createElement('div'); wrap.className='card'; wrap.style.marginBottom='10px';
      wrap.innerHTML = `
        <div class="row">
          <div class="left">
            <span class="badge">üìö ${rec.subject}</span>
            <div class="k">${rec.teamKey}</div>
          </div>
          <div class="score">${rec.score} pts</div>
        </div>
        <div class="small subtle" style="margin-top:6px">${rec.game} ‚Ä¢ ${rec.dateStr}</div>`;
      container.appendChild(wrap);
    });
  }
}

document.addEventListener('DOMContentLoaded', render);
window.addEventListener('DB_READY', render);
document.getElementById('subjectFilter').addEventListener('change', render);
document.getElementById('search').addEventListener('input', render);
</script>
</body>
</html>
